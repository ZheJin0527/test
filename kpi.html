<!DOCTYPE html>
<html lang="zh">
<head>
    <link rel="icon" type="image/png" href="images/images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐厅KPI管理系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1dfbc;
            color: #000000;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .header .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header .logo {
            height: 100px;
            width: auto;
            object-fit: contain;
        }
        
        .header .title-text {
            font-size: 60px;
            font-weight: bold;
            color: #583e04;
        }
        
        .header .controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .back-button {
            background-color: #583e04;
            color: white;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .back-button:hover {
            background-color: #462d03;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(88, 62, 4, 0.2);
        }
        
        .back-button:active {
            transform: translateY(0);
        }

        /* 餐厅选择器样式 */
        .restaurant-selector {
            background: rgb(248, 245, 235);
            border-radius: 12px;
            padding: 6px;
            display: flex;
            gap: 4px;
            border: 2px solid #583e04;
            box-shadow: 0 2px 8px rgba(88, 62, 4, 0.1);
        }

        .restaurant-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: transparent;
            color: #583e04;
            position: relative;
            min-width: 80px;
        }

        .restaurant-btn.active {
            background: #583e04;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 62, 4, 0.25);
        }

        .restaurant-btn:hover:not(.active) {
            background: rgba(88, 62, 4, 0.1);
            transform: translateY(-1px);
        }

        .restaurant-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .restaurant-btn.active::before {
            opacity: 1;
        }

        /* 总计按钮特殊样式 - 未激活时透明 */
        .restaurant-btn[data-restaurant="total"] {
            font-weight: 700;
        }

        /* 总计按钮默认状态（未激活） - 透明背景 */
        .restaurant-btn[data-restaurant="total"]:not(.active) {
            background: transparent !important;
            color: #583e04 !important;
            transform: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
        }

        /* 总计按钮激活状态 */
        .restaurant-btn[data-restaurant="total"].active {
            background: linear-gradient(135deg, #583e04, #805906) !important;
            color: white !important;
            box-shadow: 0 4px 16px rgba(88, 62, 4, 0.4) !important;
            transform: translateY(-2px) !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
        }

        /* 总计按钮悬停状态（仅在非激活时） */
        .restaurant-btn[data-restaurant="total"]:not(.active):hover {
            background: rgba(88, 62, 4, 0.1) !important;
            color: #583e04 !important;
            transform: translateY(-1px) !important;
            box-shadow: none !important;
            text-shadow: none !important;
        }
        
        .card {
            background: rgb(248, 245, 235);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .card-body {
            padding: 13.5px 24px;
        }
        
        .grid {
            display: grid;
            gap: 24px;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* 主要布局网格 */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* KPI 网格 - 左侧 */
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 16px;
        }
        
        /* 总销售额卡片 - 占两列 */
        .total-sales-card {
            grid-column: 1 / -1;
        }
        
        /* 图表容器 - 右侧 */
        .main-chart-container {
            display: flex;
            flex-direction: column;
        }
        
        /* 下方图表网格 - 现在只有一个图表 */
        .bottom-charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: auto;
            }
            
            .total-sales-card {
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 1024px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .bottom-charts {
                grid-template-columns: 1fr;
            }
            .header .logo {
                height: 50px;
            }
            .header .title-text {
                font-size: 1.25rem;
            }
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: center;
            }
            .header .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        @media (max-width: 640px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .header .logo {
                height: 40px;
            }
            .header .title-text {
                font-size: 1.125rem;
            }
            .restaurant-selector {
                flex-direction: column;
                width: 100%;
            }
            .restaurant-btn {
                min-width: auto;
            }
            .date-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
        }
        
        .kpi-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .kpi-card .icon {
            width: 32px;
            height: 32px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: bold;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px 24px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background-color: rgb(248, 245, 235);
            font-weight: bold;
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .table tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: "Segoe UI", sans-serif;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 改进的日期选择器样式 */
        .enhanced-date-picker {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 4px;
            gap: 0px;
            min-width: 220px;
            transition: all 0.2s;
            position: relative;
        }

        .enhanced-date-picker:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .enhanced-date-picker:hover {
            border-color: #9ca3af;
        }

        /* 日期选择部分 */
        .date-part {
            position: relative;
            cursor: pointer;
            padding: 0px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            min-width: 30px;
            text-align: center;
            user-select: none;
            background: transparent;
            border: 1px solid transparent;
            font-size: 14px;
            color: #374151;
        }

        .date-part:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }

        .date-part.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .date-separator {
            color: #9ca3af;
            font-weight: 500;
            user-select: none;
            margin: 0 2px;
        }

        /* 下拉选择面板 */
        .date-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            margin-top: 4px;
            max-height: 220px;
            overflow-y: auto;
            display: none;
        }

        .date-dropdown.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 年份选择网格 */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 8px;
        }

        /* 月份选择网格 */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 8px;
        }

        /* 日期选择网格 */
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0px;
            padding: 2px;
        }

        /* 选择项通用样式 */
        .date-option {
            padding: 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
            color: #374151;
            background: transparent;
            border: 1px solid transparent;
        }

        .date-option:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }

        .date-option.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .date-option.today {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .date-option.today.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* 日期网格的星期标题 */
        .day-header {
            padding: 4px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        /* 日期控制区域 */
        .date-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        /* 月份选择器保持原样 */
        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .month-selector input[type="month"] {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: "Segoe UI", sans-serif;
            min-width: 160px;
        }

        .month-selector input[type="month"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 日期信息样式 */
        .date-info {
            font-size: 14px;
            font-weight: bold;
            color: #6b7280;
            padding: 8px 12px;
            background: transparent;
            border-radius: 6px;
        }

        /* 分隔线 */
        .divider {
            width: 1px;
            height: 24px;
            background-color: #d1d5db;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .enhanced-date-picker {
                min-width: auto;
                width: 100%;
            }
            
            .date-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .month-selector {
                justify-content: center;
            }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .text-green {
            color: #583e04;
        }
        
        .text-blue {
            color: #583e04;
        }
        
        .text-purple {
            color: #583e04;
        }
        
        .text-red {
            color: #583e04;
        }
        
        .text-orange {
            color: #583e04;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* 餐厅特定的颜色主题 */
        .restaurant-j1 {
            --primary-color: #583e04;
            --secondary-color: #805906;
        }

        .restaurant-j2 {
            --primary-color: #583e04;
            --secondary-color: #805906;
        }

        .restaurant-j3 {
            --primary-color: #583e04;
            --secondary-color: #805906;
        }

        .restaurant-total {
            --primary-color: #583e04;
            --secondary-color: #805906;
        }

        /* 动态应用颜色 */
        .dynamic-color {
            color: var(--primary-color) !important;
        }

        .dynamic-bg {
            background-color: var(--primary-color) !important;
        }

        .dynamic-border {
            border-color: var(--primary-color) !important;
        }
    </style>
</head>
<body class="restaurant-j1">
    <div id="app">
        <div class="container">
            <div class="header">
                <div class="logo-container">
                    <img src="images/images/tokyo.png" alt="Company Logo" class="logo">
                    <span class="title-text">TOKYO JAPANESE CUISINE</span>
                </div>
                <div class="controls">
                    <!-- 餐厅选择器 -->
                    <div class="restaurant-selector">
                        <button class="restaurant-btn active" data-restaurant="j1" onclick="switchRestaurant('j1')">
                            J1
                        </button>
                        <button class="restaurant-btn" data-restaurant="j2" onclick="switchRestaurant('j2')">
                            J2
                        </button>
                        <button class="restaurant-btn" data-restaurant="j3" onclick="switchRestaurant('j3')">
                            J3
                        </button>
                        <button class="restaurant-btn" data-restaurant="total" onclick="switchRestaurant('total')">
                            总计
                        </button>
                    </div>
                    <button class="back-button" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i>
                        返回上一页
                    </button>
                </div>
            </div>
            
            <!-- Date Controls -->
            <div class="card" style="margin-bottom: 32px;">
                <div class="card-body">
                    <div class="date-controls">
                        <!-- 月份选择器 -->
                        <div class="month-selector">
                            <i class="fas fa-calendar" style="color: #6b7280;"></i>
                            <label class="form-label" style="margin: 0;">选择月份:</label>
                            <input type="month" id="month-selector" onchange="handleMonthChange()">
                        </div>
                        
                        <div class="divider"></div>
                        
                        <!-- 开始日期选择器 -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="form-label" style="margin: 0;">开始日期:</label>
                            <div class="enhanced-date-picker" id="start-date-picker">
                                <div class="date-part" data-type="year" onclick="showDateDropdown('start', 'year')">
                                    <span id="start-year-display">2024</span>
                                </div>
                                <span class="date-separator">年</span>
                                <div class="date-part" data-type="month" onclick="showDateDropdown('start', 'month')">
                                    <span id="start-month-display">01</span>
                                </div>
                                <span class="date-separator">月</span>
                                <div class="date-part" data-type="day" onclick="showDateDropdown('start', 'day')">
                                    <span id="start-day-display">01</span>
                                </div>
                                <span class="date-separator">日</span>
                                
                                <!-- 下拉选择面板 -->
                                <div class="date-dropdown" id="start-dropdown">
                                    <!-- 动态内容将在这里生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 结束日期选择器 -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="form-label" style="margin: 0;">结束日期:</label>
                            <div class="enhanced-date-picker" id="end-date-picker">
                                <div class="date-part" data-type="year" onclick="showDateDropdown('end', 'year')">
                                    <span id="end-year-display">2024</span>
                                </div>
                                <span class="date-separator">年</span>
                                <div class="date-part" data-type="month" onclick="showDateDropdown('end', 'month')">
                                    <span id="end-month-display">01</span>
                                </div>
                                <span class="date-separator">月</span>
                                <div class="date-part" data-type="day" onclick="showDateDropdown('end', 'day')">
                                    <span id="end-day-display">01</span>
                                </div>
                                <span class="date-separator">日</span>
                                
                                <!-- 下拉选择面板 -->
                                <div class="date-dropdown" id="end-dropdown">
                                    <!-- 动态内容将在这里生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="date-info" class="date-info"></div>
                    </div>
                </div>
            </div>
            
            <!-- Main Layout: KPI Cards + Main Chart -->
            <div class="main-layout">
                <!-- KPI Cards Grid - Left Side -->
                <div class="kpi-grid">
                    <!-- 总销售额 - 占两列 -->
                    <div class="card total-sales-card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">总销售额</p>
                                    <p class="kpi-value" id="total-sales">RM 0</p>
                                </div>
                                <div class="icon text-green">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 净销售额 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">净销售额</p>
                                    <p class="kpi-value" id="net-sales">RM 0</p>
                                </div>
                                <div class="icon text-green">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 桌子总数 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">桌子总数</p>
                                    <p class="kpi-value" id="total-tables">0</p>
                                </div>
                                <div class="icon dynamic-color">
                                    <i class="fas fa-table"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 顾客总数 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">顾客总数</p>
                                    <p class="kpi-value" id="total-diners">0</p>
                                </div>
                                <div class="icon dynamic-color">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 人均消费 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">人均消费</p>
                                    <p class="kpi-value" id="avg-per-diner">RM 0</p>
                                </div>
                                <div class="icon dynamic-color">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 常客 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">常客</p>
                                    <p class="kpi-value" id="total-returning">0</p>
                                </div>
                                <div class="icon text-blue">
                                    <i class="fas fa-user-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 新客人 -->
                    <div class="card">
                        <div class="card-body">
                            <div class="kpi-card">
                                <div>
                                    <p class="kpi-label">新客人</p>
                                    <p class="kpi-value" id="total-new">0</p>
                                </div>
                                <div class="icon text-purple">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Chart - Right Side -->
                <div class="main-chart-container">
                    <div class="card" style="height: 100%;">
                        <div class="card-body" style="height: 100%; display: flex; flex-direction: column;">
                            <h3 id="main-chart-title" style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 16px;">净销售额趋势</h3>
                            <div class="chart-container" style="flex: 1;">
                                <canvas id="sales-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Charts - 合并后的图表 -->
            <div class="bottom-charts" style="margin-bottom: 32px;">
                <div class="card">
                    <div class="card-body">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 16px;">用餐人数与顾客类型分析</h3>
                        <div class="chart-container">
                            <canvas id="combined-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detail Table -->
            <div class="card">
                <div class="card-body" style="padding-bottom: 0;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 24px;">详细数据</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table" id="dashboard-table">
                        <thead>
                            <tr id="table-header">
                                <th>日期</th>
                                <th>总销售额</th>
                                <th>净销售额</th>
                                <th>顾客人数</th>
                                <th>使用桌数</th>
                                <th>人均消费</th>
                                <th>常客</th>
                                <th>新客人</th>
                                <th>常客率</th>
                                <th>新客人率</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API 配置
        const API_BASE_URL = 'api.php';
        
        // 应用状态
        let actualData = [];
        let allRestaurantsData = {}; // 存储所有餐厅的数据
        let currentRestaurant = 'j1';
        let dateRange = {
            startDate: getTodayMinusMonth(),
            endDate: getToday()
        };
        let selectedMonth = getCurrentMonth();
        
        let salesChart = null;
        let combinedChart = null;
        
        // 日期选择器状态
        let currentDatePicker = null;
        let currentDateType = null;
        let startDateValue = { year: null, month: null, day: null };
        let endDateValue = { year: null, month: null, day: null };

        // 餐厅配置
        const restaurantConfig = {
            j1: {
                name: 'J1',
                tableName: 'j1data_view',
                colors: {
                    primary: '#583e04',
                    secondary: '#805906'
                }
            },
            j2: {
                name: 'J2',
                tableName: 'j2data_view',
                colors: {
                    primary: '#583e04',
                    secondary: '#805906'
                }
            },
            j3: {
                name: 'J3',
                tableName: 'j3data_view',
                colors: {
                    primary: '#583e04',
                    secondary: '#805906'
                }
            },
            total: {
                name: '总计',
                tableName: 'all_restaurants',
                colors: {
                    primary: '#583e04',
                    secondary: '#805906'
                }
            }
        };

        // 工具函数
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function getTodayMinusMonth() {
            const date = new Date();
            date.setMonth(date.getMonth() - 1);
            return date.toISOString().split('T')[0];
        }

        function getCurrentMonth() {
            return new Date().toISOString().slice(0, 7);
        }

        // 增强的日期选择器功能
        function initEnhancedDatePickers() {
            const startDate = new Date(dateRange.startDate);
            const endDate = new Date(dateRange.endDate);
            
            // 设置初始值
            startDateValue = {
                year: startDate.getFullYear(),
                month: startDate.getMonth() + 1,
                day: startDate.getDate()
            };
            
            endDateValue = {
                year: endDate.getFullYear(),
                month: endDate.getMonth() + 1,
                day: endDate.getDate()
            };
            
            // 更新显示
            updateDateDisplay('start');
            updateDateDisplay('end');
            
            // 绑定全局点击事件以关闭下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.enhanced-date-picker')) {
                    hideAllDropdowns();
                }
            });
        }

        function updateDateDisplay(prefix) {
            const dateValue = prefix === 'start' ? startDateValue : endDateValue;
            
            document.getElementById(`${prefix}-year-display`).textContent = dateValue.year;
            document.getElementById(`${prefix}-month-display`).textContent = String(dateValue.month).padStart(2, '0');
            document.getElementById(`${prefix}-day-display`).textContent = String(dateValue.day).padStart(2, '0');
        }

        function showDateDropdown(prefix, type) {
            // 隐藏其他下拉框
            hideAllDropdowns();
            
            const dropdown = document.getElementById(`${prefix}-dropdown`);
            const datePicker = document.getElementById(`${prefix}-date-picker`);
            
            // 设置当前状态
            currentDatePicker = prefix;
            currentDateType = type;
            
            // 移除所有active状态
            datePicker.querySelectorAll('.date-part').forEach(part => {
                part.classList.remove('active');
            });
            
            // 添加当前选中的active状态
            datePicker.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // 生成下拉内容
            generateDropdownContent(prefix, type);
            
            // 显示下拉框
            dropdown.classList.add('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.date-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            document.querySelectorAll('.date-part').forEach(part => {
                part.classList.remove('active');
            });
            
            currentDatePicker = null;
            currentDateType = null;
        }

        function generateDropdownContent(prefix, type) {
            const dropdown = document.getElementById(`${prefix}-dropdown`);
            const dateValue = prefix === 'start' ? startDateValue : endDateValue;
            const today = new Date();
            
            dropdown.innerHTML = '';
            
            if (type === 'year') {
                // 生成年份选择
                const yearGrid = document.createElement('div');
                yearGrid.className = 'year-grid';
                
                const currentYear = today.getFullYear();
                const startYear = 2020;
                const endYear = currentYear + 1;
                
                for (let year = startYear; year <= endYear; year++) {
                    const yearOption = document.createElement('div');
                    yearOption.className = 'date-option';
                    yearOption.textContent = year;
                    
                    if (year === dateValue.year) {
                        yearOption.classList.add('selected');
                    }
                    
                    if (year === currentYear) {
                        yearOption.classList.add('today');
                    }
                    
                    yearOption.addEventListener('click', function() {
                        selectDateValue(prefix, 'year', year);
                    });
                    
                    yearGrid.appendChild(yearOption);
                }
                
                dropdown.appendChild(yearGrid);
                
            } else if (type === 'month') {
                // 生成月份选择
                const monthGrid = document.createElement('div');
                monthGrid.className = 'month-grid';
                
                const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                
                months.forEach((monthName, index) => {
                    const monthValue = index + 1;
                    const monthOption = document.createElement('div');
                    monthOption.className = 'date-option';
                    monthOption.textContent = monthName;
                    
                    if (monthValue === dateValue.month) {
                        monthOption.classList.add('selected');
                    }
                    
                    if (dateValue.year === today.getFullYear() && monthValue === today.getMonth() + 1) {
                        monthOption.classList.add('today');
                    }
                    
                    monthOption.addEventListener('click', function() {
                        selectDateValue(prefix, 'month', monthValue);
                    });
                    
                    monthGrid.appendChild(monthOption);
                });
                
                dropdown.appendChild(monthGrid);
                
            } else if (type === 'day') {
                // 生成日期选择
                const dayGrid = document.createElement('div');
                dayGrid.className = 'day-grid';
                
                // 添加星期标题
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    dayGrid.appendChild(dayHeader);
                });
                
                // 计算当月信息
                const year = dateValue.year;
                const month = dateValue.month;
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();
                
                // 添加空白日期（上个月的）
                for (let i = 0; i < startDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    dayGrid.appendChild(emptyDay);
                }
                
                // 添加当月日期
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayOption = document.createElement('div');
                    dayOption.className = 'date-option';
                    dayOption.textContent = day;
                    
                    if (day === dateValue.day) {
                        dayOption.classList.add('selected');
                    }
                    
                    if (year === today.getFullYear() && 
                        month === today.getMonth() + 1 && 
                        day === today.getDate()) {
                        dayOption.classList.add('today');
                    }
                    
                    dayOption.addEventListener('click', function() {
                        selectDateValue(prefix, 'day', day);
                    });
                    
                    dayGrid.appendChild(dayOption);
                }
                
                dropdown.appendChild(dayGrid);
            }
        }

        function selectDateValue(prefix, type, value) {
            const dateValue = prefix === 'start' ? startDateValue : endDateValue;
            
            // 更新值
            dateValue[type] = value;
            
            // 如果选择了年份或月份，需要验证日期的有效性
            if (type === 'year' || type === 'month') {
                const daysInMonth = new Date(dateValue.year, dateValue.month, 0).getDate();
                if (dateValue.day > daysInMonth) {
                    dateValue.day = daysInMonth;
                }
            }
            
            // 更新显示
            updateDateDisplay(prefix);
            
            // 隐藏下拉框
            hideAllDropdowns();
            
            // 更新日期范围并重新加载数据
            updateDateRangeFromPickers();
        }

        async function updateDateRangeFromPickers() {
            const startDateStr = `${startDateValue.year}-${String(startDateValue.month).padStart(2, '0')}-${String(startDateValue.day).padStart(2, '0')}`;
            const endDateStr = `${endDateValue.year}-${String(endDateValue.month).padStart(2, '0')}-${String(endDateValue.day).padStart(2, '0')}`;
            
            // 验证日期有效性
            if (new Date(startDateStr) > new Date(endDateStr)) {
                alert('开始日期不能晚于结束日期');
                return;
            }
            
            dateRange = {
                startDate: startDateStr,
                endDate: endDateStr
            };
            
            await loadData({
                start_date: dateRange.startDate,
                end_date: dateRange.endDate
            });
            updateDashboard();
        }

        // 切换餐厅
        function switchRestaurant(restaurant) {
            if (currentRestaurant === restaurant) return;
            
            currentRestaurant = restaurant;
            
            // 更新按钮状态
            document.querySelectorAll('.restaurant-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.restaurant === restaurant) {
                    btn.classList.add('active');
                }
            });
            
            // 更新页面主题色
            document.body.className = `restaurant-${restaurant}`;
            updateThemeColors(restaurant);
            
            // 重新加载数据
            loadData().then(() => {
                updateDashboard();
            });
        }

        // 更新主题颜色
        function updateThemeColors(restaurant) {
            const config = restaurantConfig[restaurant];
            const root = document.documentElement;
            
            root.style.setProperty('--primary-color', config.colors.primary);
            root.style.setProperty('--secondary-color', config.colors.secondary);
            
            // 更新餐厅选择器边框色
            const selector = document.querySelector('.restaurant-selector');
            selector.style.borderColor = config.colors.primary;
        }

        // 返回上一页功能
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }

        // API 调用函数
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || '请求失败');
                }
                
                return data;
            } catch (error) {
                console.error('API调用失败:', error);
                throw error;
            }
        }

        // 加载所有餐厅数据
        async function loadAllRestaurantsData(params = {}) {
            try {
                const restaurants = ['j1', 'j2', 'j3'];
                const promises = restaurants.map(async (restaurant) => {
                    const queryParams = new URLSearchParams({
                        action: 'list',
                        restaurant: restaurant,
                        ...params
                    });
                    
                    try {
                        const result = await apiCall(`?${queryParams}`);
                        return { restaurant, data: result.data || [] };
                    } catch (error) {
                        console.error(`加载${restaurant}数据失败:`, error);
                        return { restaurant, data: [] };
                    }
                });
                
                const results = await Promise.all(promises);
                
                // 存储各餐厅数据
                allRestaurantsData = {};
                results.forEach(({ restaurant, data }) => {
                    allRestaurantsData[restaurant] = data;
                });
                
                return allRestaurantsData;
            } catch (error) {
                console.error('加载所有餐厅数据失败:', error);
                allRestaurantsData = {};
                return {};
            }
        }

        // 合并所有餐厅数据
        function mergeAllRestaurantsData() {
            const dateMap = new Map();
            
            // 遍历所有餐厅数据
            Object.values(allRestaurantsData).forEach(restaurantData => {
                restaurantData.forEach(item => {
                    const date = item.date;
                    if (!dateMap.has(date)) {
                        dateMap.set(date, {
                            date: date,
                            gross_sales: 0,
                            net_sales: 0,
                            diners: 0,
                            tables_used: 0,
                            returning_customers: 0,
                            new_customers: 0
                        });
                    }
                    
                    const existing = dateMap.get(date);
                    existing.gross_sales += parseFloat(item.gross_sales) || 0;
                    existing.net_sales += parseFloat(item.net_sales) || 0;
                    existing.diners += parseInt(item.diners) || 0;
                    existing.tables_used += parseInt(item.tables_used) || 0;
                    existing.returning_customers += parseInt(item.returning_customers) || 0;
                    existing.new_customers += parseInt(item.new_customers) || 0;
                });
            });
            
            // 转换为数组并排序
            return Array.from(dateMap.values()).sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // 数据获取
        async function loadData(params = {}) {
            try {
                if (currentRestaurant === 'total') {
                    // 加载所有餐厅数据
                    await loadAllRestaurantsData(params);
                    actualData = mergeAllRestaurantsData();
                } else {
                    // 加载单个餐厅数据
                    const queryParams = new URLSearchParams({
                        action: 'list',
                        restaurant: currentRestaurant,
                        ...params
                    });
                    
                    const result = await apiCall(`?${queryParams}`);
                    actualData = result.data || [];
                }
                return actualData;
            } catch (error) {
                actualData = [];
                return [];
            }
        }

        async function loadSummary(startDate, endDate) {
            try {
                if (currentRestaurant === 'total') {
                    // 为总计模式计算汇总数据
                    const filteredData = getFilteredKPIData();
                    if (filteredData.length > 0) {
                        return {
                            total_gross_sales: filteredData.reduce((sum, item) => sum + item.totalSales, 0),
                            total_net_sales: filteredData.reduce((sum, item) => sum + item.netSales, 0),
                            total_tables: filteredData.reduce((sum, item) => sum + item.tablesUsed, 0),
                            total_diners: filteredData.reduce((sum, item) => sum + item.diners, 0),
                            total_returning_customers: filteredData.reduce((sum, item) => sum + item.returningCustomers, 0),
                            total_new_customers: filteredData.reduce((sum, item) => sum + item.newCustomers, 0),
                            total_days: filteredData.length
                        };
                    }
                    return {};
                } else {
                    const queryParams = new URLSearchParams({
                        action: 'summary',
                        restaurant: currentRestaurant,
                        start_date: startDate,
                        end_date: endDate
                    });
                    
                    const result = await apiCall(`?${queryParams}`);
                    return result.data;
                }
            } catch (error) {
                return {};
            }
        }

        // 初始化应用
        async function initApp() {
            document.getElementById('month-selector').value = selectedMonth;
            
            // 初始化增强日期选择器
            initEnhancedDatePickers();
            
            // 初始化主题色
            updateThemeColors(currentRestaurant);
            
            await loadData();
            updateDashboard();
        }

        // 日期处理
        async function handleMonthChange() {
            const month = document.getElementById('month-selector').value;
            selectedMonth = month;
            
            const year = month.split('-')[0];
            const monthNum = month.split('-')[1];
            const firstDay = `${year}-${monthNum}-01`;
            const lastDay = new Date(year, monthNum, 0).getDate();
            const lastDayFormatted = `${year}-${monthNum}-${lastDay.toString().padStart(2, '0')}`;
            
            dateRange = {
                startDate: firstDay,
                endDate: lastDayFormatted
            };
            
            // 更新增强日期选择器的值
            startDateValue = {
                year: parseInt(year),
                month: parseInt(monthNum),
                day: 1
            };
            
            endDateValue = {
                year: parseInt(year),
                month: parseInt(monthNum),
                day: lastDay
            };
            
            updateDateDisplay('start');
            updateDateDisplay('end');
            
            await loadData({
                start_date: dateRange.startDate,
                end_date: dateRange.endDate
            });
            updateDashboard();
        }

        // 数据转换和过滤
        function convertToKPIFormat(data) {
            return data.map(item => {
                const diners = parseInt(item.diners) || 0;
                const returningCustomers = parseInt(item.returning_customers) || 0;
                const newCustomers = parseInt(item.new_customers) || 0;
                const totalCustomers = returningCustomers + newCustomers;
                
                return {
                    date: item.date,
                    totalSales: parseFloat(item.gross_sales) || 0,
                    netSales: parseFloat(item.net_sales) || 0,
                    diners: diners,
                    tablesUsed: parseInt(item.tables_used) || 0,
                    returningCustomers: returningCustomers,
                    newCustomers: newCustomers,
                    avgSalesPerDiner: diners > 0 ? (parseFloat(item.gross_sales) || 0) / diners : 0,
                    returningRate: totalCustomers > 0 ? (returningCustomers / totalCustomers) * 100 : 0,
                    newCustomersRate: totalCustomers > 0 ? (newCustomers / totalCustomers) * 100 : 0
                };
            });
        }

        function getFilteredKPIData() {
            const kpiData = convertToKPIFormat(actualData);
            return kpiData.filter(item => {
                const itemDate = new Date(item.date);
                const start = new Date(dateRange.startDate);
                const end = new Date(dateRange.endDate);
                return itemDate >= start && itemDate <= end;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // 更新仪表板
        async function updateDashboard() {
            const summary = await loadSummary(dateRange.startDate, dateRange.endDate);
            const filteredData = getFilteredKPIData();
            
            // 使用前端数据重新计算精确的汇总统计
            let displaySummary;
            if (filteredData.length > 0) {
                displaySummary = {
                    total_gross_sales: filteredData.reduce((sum, item) => sum + item.totalSales, 0),
                    total_net_sales: filteredData.reduce((sum, item) => sum + item.netSales, 0),
                    total_tables: filteredData.reduce((sum, item) => sum + item.tablesUsed, 0),
                    total_diners: filteredData.reduce((sum, item) => sum + item.diners, 0),
                    total_returning_customers: filteredData.reduce((sum, item) => sum + item.returningCustomers, 0),
                    total_new_customers: filteredData.reduce((sum, item) => sum + item.newCustomers, 0),
                    total_days: filteredData.length
                };
                // 重新计算真正的平均每人消费
                displaySummary.avg_per_diner = displaySummary.total_diners > 0 ? 
                    displaySummary.total_gross_sales / displaySummary.total_diners : 0;
            } else {
                // 如果没有过滤数据，使用API数据但重新计算平均值
                displaySummary = {
                    total_gross_sales: parseFloat(summary.total_gross_sales || 0),
                    total_net_sales: parseFloat(summary.total_net_sales || 0),
                    total_tables: parseInt(summary.total_tables || 0),
                    total_diners: parseInt(summary.total_diners || 0),
                    total_returning_customers: parseInt(summary.total_returning_customers || 0),
                    total_new_customers: parseInt(summary.total_new_customers || 0),
                    total_days: parseInt(summary.total_days || 0)
                };
                // 重新计算平均每人消费，不使用API的avg_per_diner
                displaySummary.avg_per_diner = displaySummary.total_diners > 0 ? 
                    displaySummary.total_gross_sales / displaySummary.total_diners : 0;
            }
            
            // 更新KPI卡片
            document.getElementById('total-sales').textContent = `RM ${parseFloat(displaySummary.total_gross_sales || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('net-sales').textContent = `RM ${parseFloat(displaySummary.total_net_sales || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('total-tables').textContent = (displaySummary.total_tables || 0).toLocaleString();
            document.getElementById('total-diners').textContent = (displaySummary.total_diners || 0).toLocaleString();
            document.getElementById('avg-per-diner').textContent = `RM ${parseFloat(displaySummary.avg_per_diner || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('total-returning').textContent = (displaySummary.total_returning_customers || 0).toLocaleString();
            document.getElementById('total-new').textContent = (displaySummary.total_new_customers || 0).toLocaleString();
            
            // 更新日期信息
            document.getElementById('date-info').textContent = `已选择 ${displaySummary.total_days || 0} 天的数据 - ${restaurantConfig[currentRestaurant].name}`;
            
            // 更新图表标题（总计模式下显示特殊标题）
            const chartTitle = document.getElementById('main-chart-title');
            if (currentRestaurant === 'total') {
                chartTitle.textContent = '净销售额趋势 (三店合计)';
            } else {
                chartTitle.textContent = '净销售额趋势';
            }
            
            // 更新图表
            updateCharts(filteredData);
            
            // 更新详细表格
            updateDashboardTable(filteredData);
        }

        // 准备分餐厅对比数据
        function prepareComparisonData() {
            if (currentRestaurant !== 'total' || !allRestaurantsData) {
                return null;
            }
            
            const dateSet = new Set();
            Object.values(allRestaurantsData).forEach(data => {
                data.forEach(item => dateSet.add(item.date));
            });
            
            const sortedDates = Array.from(dateSet).sort();
            const filteredDates = sortedDates.filter(date => {
                const itemDate = new Date(date);
                const start = new Date(dateRange.startDate);
                const end = new Date(dateRange.endDate);
                return itemDate >= start && itemDate <= end;
            });
            
            const restaurants = ['j1', 'j2', 'j3'];
            const comparisonData = {
                dates: filteredDates,
                restaurants: {}
            };
            
            restaurants.forEach(restaurant => {
                const restaurantData = allRestaurantsData[restaurant] || [];
                comparisonData.restaurants[restaurant] = filteredDates.map(date => {
                    const dayData = restaurantData.find(item => item.date === date);
                    return dayData ? {
                        totalSales: parseFloat(dayData.gross_sales) || 0,
                        netSales: parseFloat(dayData.net_sales) || 0,
                        diners: parseInt(dayData.diners) || 0,
                        tablesUsed: parseInt(dayData.tables_used) || 0,
                        returningCustomers: parseInt(dayData.returning_customers) || 0,
                        newCustomers: parseInt(dayData.new_customers) || 0
                    } : {
                        totalSales: 0,
                        netSales: 0,
                        diners: 0,
                        tablesUsed: 0,
                        returningCustomers: 0,
                        newCustomers: 0
                    };
                });
            });
            
            return comparisonData;
        }

        function updateCharts(data) {
            const ctx1 = document.getElementById('sales-chart').getContext('2d');
            const ctx2 = document.getElementById('combined-chart').getContext('2d');
            
            const config = restaurantConfig[currentRestaurant];
            
            // 餐厅颜色配置
            const restaurantColors = {
                j1: { 
                    primary: '#583e04', 
                    secondary: '#805906',
                    returning: '#583e04',
                    new: '#805906'
                },
                j2: { 
                    primary: '#d97706', 
                    secondary: '#f59e0b',
                    returning: '#d97706',
                    new: '#f59e0b'
                },
                j3: { 
                    primary: '#dc2626', 
                    secondary: '#f87171',
                    returning: '#dc2626',
                    new: '#f87171'
                }
            };
            
            // 销售趋势图
            if (salesChart) {
                salesChart.destroy();
            }
            
            if (currentRestaurant === 'total') {
                // 总计模式：显示三间餐厅的对比数据
                const comparisonData = prepareComparisonData();
                
                salesChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: comparisonData.dates.map(date => new Date(date).getDate().toString()),
                        datasets: [
                            {
                                label: 'J1 净销售额',
                                data: comparisonData.restaurants.j1.map(item => item.netSales),
                                borderColor: restaurantColors.j1.primary,
                                backgroundColor: restaurantColors.j1.primary + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'J2 净销售额',
                                data: comparisonData.restaurants.j2.map(item => item.netSales),
                                borderColor: restaurantColors.j2.primary,
                                backgroundColor: restaurantColors.j2.primary + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'J3 净销售额',
                                data: comparisonData.restaurants.j3.map(item => item.netSales),
                                borderColor: restaurantColors.j3.primary,
                                backgroundColor: restaurantColors.j3.primary + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'RM ' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        if (context.length > 0) {
                                            const date = comparisonData.dates[context[0].dataIndex];
                                            return `${date} (${new Date(date).getDate()}号)`;
                                        }
                                        return '';
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': RM ' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    },
                                    afterBody: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const j1Sales = comparisonData.restaurants.j1[dataIndex].netSales;
                                            const j2Sales = comparisonData.restaurants.j2[dataIndex].netSales;
                                            const j3Sales = comparisonData.restaurants.j3[dataIndex].netSales;
                                            const totalSales = j1Sales + j2Sales + j3Sales;
                                            
                                            return [
                                                '',
                                                '--- 当日汇总 ---',
                                                `总净销售额: RM ${totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                            ];
                                        }
                                        return [];
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } else {
                // 单店模式：显示单店数据
                salesChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.map(item => new Date(item.date).getDate().toString()),
                        datasets: [{
                            label: '净销售额',
                            data: data.map(item => item.netSales),
                            borderColor: config.colors.primary,
                            backgroundColor: config.colors.primary,
                            tension: 0.1,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'RM ' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const item = data[dataIndex];
                                            return `${item.date} (${new Date(item.date).getDate()}号)`;
                                        }
                                        return '';
                                    },
                                    label: function(context) {
                                        return '净销售额: RM ' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    },
                                    afterBody: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const item = data[dataIndex];
                                            
                                            return [
                                                '',
                                                '--- 当日详情 ---',
                                                `总销售额: RM ${item.totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                                                `净销售额: RM ${item.netSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                            ];
                                        }
                                        return [];
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 合并的用餐人数与顾客类型图表
            if (combinedChart) {
                combinedChart.destroy();
            }
            
            if (currentRestaurant === 'total') {
                // 总计模式：显示三间餐厅的对比数据
                const comparisonData = prepareComparisonData();
                
                combinedChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: comparisonData.dates.map(date => new Date(date).getDate().toString()),
                        datasets: [
                            {
                                label: 'J1 常客',
                                data: comparisonData.restaurants.j1.map(item => item.returningCustomers),
                                backgroundColor: restaurantColors.j1.returning,
                                borderColor: restaurantColors.j1.returning,
                                stack: 'j1'
                            },
                            {
                                label: 'J1 新客人',
                                data: comparisonData.restaurants.j1.map(item => item.newCustomers),
                                backgroundColor: restaurantColors.j1.new,
                                borderColor: restaurantColors.j1.new,
                                stack: 'j1'
                            },
                            {
                                label: 'J2 常客',
                                data: comparisonData.restaurants.j2.map(item => item.returningCustomers),
                                backgroundColor: restaurantColors.j2.returning,
                                borderColor: restaurantColors.j2.returning,
                                stack: 'j2'
                            },
                            {
                                label: 'J2 新客人',
                                data: comparisonData.restaurants.j2.map(item => item.newCustomers),
                                backgroundColor: restaurantColors.j2.new,
                                borderColor: restaurantColors.j2.new,
                                stack: 'j2'
                            },
                            {
                                label: 'J3 常客',
                                data: comparisonData.restaurants.j3.map(item => item.returningCustomers),
                                backgroundColor: restaurantColors.j3.returning,
                                borderColor: restaurantColors.j3.returning,
                                stack: 'j3'
                            },
                            {
                                label: 'J3 新客人',
                                data: comparisonData.restaurants.j3.map(item => item.newCustomers),
                                backgroundColor: restaurantColors.j3.new,
                                borderColor: restaurantColors.j3.new,
                                stack: 'j3'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '顾客数量'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                filter: function(tooltipItem) {
                                    return tooltipItem.parsed.y > 0;
                                },
                                callbacks: {
                                    title: function(context) {
                                        if (context.length > 0) {
                                            const date = comparisonData.dates[context[0].dataIndex];
                                            return `${date} (${new Date(date).getDate()}号)`;
                                        }
                                        return '';
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '人';
                                    },
                                    afterBody: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const j1Data = comparisonData.restaurants.j1[dataIndex];
                                            const j2Data = comparisonData.restaurants.j2[dataIndex];
                                            const j3Data = comparisonData.restaurants.j3[dataIndex];
                                            
                                            const j1Total = j1Data.returningCustomers + j1Data.newCustomers;
                                            const j2Total = j2Data.returningCustomers + j2Data.newCustomers;
                                            const j3Total = j3Data.returningCustomers + j3Data.newCustomers;
                                            const grandTotal = j1Total + j2Total + j3Total;
                                            
                                            const j1Diners = j1Data.diners;
                                            const j2Diners = j2Data.diners;
                                            const j3Diners = j3Data.diners;
                                            const totalDiners = j1Diners + j2Diners + j3Diners;
                                            
                                            let summary = ['', '--- 当日汇总 ---'];
                                            summary.push(`总用餐人数: ${totalDiners}人`);
                                            summary.push(`总顾客数: ${grandTotal}人`);
                                            
                                            if (j1Total > 0) {
                                                const j1RetRate = ((j1Data.returningCustomers / j1Total) * 100).toFixed(1);
                                                summary.push(`J1: ${j1Diners}人用餐, ${j1Total}位顾客 (${j1RetRate}%常客)`);
                                            }
                                            if (j2Total > 0) {
                                                const j2RetRate = ((j2Data.returningCustomers / j2Total) * 100).toFixed(1);
                                                summary.push(`J2: ${j2Diners}人用餐, ${j2Total}位顾客 (${j2RetRate}%常客)`);
                                            }
                                            if (j3Total > 0) {
                                                const j3RetRate = ((j3Data.returningCustomers / j3Total) * 100).toFixed(1);
                                                summary.push(`J3: ${j3Diners}人用餐, ${j3Total}位顾客 (${j3RetRate}%常客)`);
                                            }
                                            
                                            return summary;
                                        }
                                        return [];
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } else {
                // 单店模式：显示用餐人数和顾客类型的合并数据
                combinedChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => new Date(item.date).getDate().toString()),
                        datasets: [
                            {
                                label: '常客',
                                data: data.map(item => item.returningCustomers),
                                backgroundColor: config.colors.primary,
                                borderColor: config.colors.primary,
                                stack: 'customers'
                            },
                            {
                                label: '新客人',
                                data: data.map(item => item.newCustomers),
                                backgroundColor: config.colors.secondary,
                                borderColor: config.colors.secondary,
                                stack: 'customers'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '顾客数量'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const item = data[dataIndex];
                                            return `${item.date} (${new Date(item.date).getDate()}号)`;
                                        }
                                        return '';
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '人';
                                    },
                                    afterBody: function(context) {
                                        if (context.length > 0) {
                                            const dataIndex = context[0].dataIndex;
                                            const item = data[dataIndex];
                                            const totalCustomers = item.returningCustomers + item.newCustomers;
                                            
                                            let summary = ['', '--- 当日详情 ---'];
                                            summary.push(`顾客人数: ${item.diners}人`);

                                            
                                            if (totalCustomers > 0) {
                                                const returningRate = ((item.returningCustomers / totalCustomers) * 100).toFixed(1);
                                                const newRate = ((item.newCustomers / totalCustomers) * 100).toFixed(1);
                                                summary.push(`常客率: ${returningRate}%`);
                                                summary.push(`新客人率: ${newRate}%`);
                                            }
                                            
                                            summary.push(`使用桌数: ${item.tablesUsed}桌`);
                                            summary.push(`人均消费: RM ${item.avgSalesPerDiner.toFixed(2)}`);
                                            
                                            return summary;
                                        }
                                        return [];
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateDashboardTable(data) {
            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
            
            // 更新表头（总计模式下添加标识）
            const tableHeader = document.getElementById('table-header');
            const firstHeader = tableHeader.querySelector('th');
            if (currentRestaurant === 'total') {
                firstHeader.textContent = '日期 (三店合计)';
            } else {
                firstHeader.textContent = '日期';
            }
            
            // 显示所有选择的数据，而不是限制为10条
            data.forEach(item => {
                const totalCustomers = item.returningCustomers + item.newCustomers;
                const returningRate = totalCustomers > 0 ? ((item.returningCustomers / totalCustomers) * 100).toFixed(1) : 0;
                const newCustomersRate = totalCustomers > 0 ? ((item.newCustomers / totalCustomers) * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>RM ${item.totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>RM ${item.netSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.diners}</td>
                    <td>${item.tablesUsed}</td>
                    <td>RM ${item.avgSalesPerDiner.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${item.returningCustomers}</td>
                    <td>${item.newCustomers}</td>
                    <td>${returningRate}%</td>
                    <td>${newCustomersRate}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>