<!DOCTYPE html>
<html lang="zh">
<head>
  <link rel="icon" type="image/png" href="images/images/logo.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>注册 - KUNZZ HOLDINGS</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <section class="register-section">
  <div class="register-form">
    <h2>创建新账户</h2>
    <form id="register-form">
      <input type="text" name="name" placeholder="姓名" required />

      <input type="email" name="email" placeholder="请输入您的 Gmail" required
        pattern="[a-zA-Z0-9._%+-]+@gmail\.com$"
        title="请输入以 @gmail.com 结尾的邮箱地址" />

      <input type="tel" name="phone_number" placeholder="联系电话" pattern="^(\+?\d{1,4}[-.\s]?)?(\d{7,15})$" title="请输入有效的电话号码" required />  

      <input type="text" name="ic_number" placeholder="身份证号码" required
        pattern="\d{12}" title="请输入12位身份证号码（不含符号）" />

      <input type="text" name="position" placeholder="职位" required />

      <!-- 新增银行选择 -->
      <select name="bank_name" required>
        <option value="" disabled selected>请选择银行</option>
        <option value="Affin Bank Berhad">Affin Bank Berhad</option>
        <option value="Agro">Affin Bank</option>
        <option value="Alliance Bank Berhad">Alliance Bank Berhad</option>
        <option value="Ambank Berhad">Ambank Berhad</option>
        <option value="Bangkok Bank Berhad">Bangkok Bank Berhad</option>
        <option value="Bank Islam Malaysia Berhad">Bank Islam Malaysia Berhad</option>
        <option value="Bank Kerjasama Rakyat Malaysia Berhad">Bank Kerjasama Rakyat Malaysia Berhad</option>
        <option value="Bank Muamalat Malaysia Berhad">Bank Muamalat Malaysia Berhad</option>
        <option value="Bank Simpanan Nasional Berhad">Bank Simpanan Nasional Berhad</option>
        <option value="Maybank">Maybank</option>
        <option value="CIMB">CIMB</option>
        <option value="Public Bank">Public Bank</option>
        <option value="RHB Bank">RHB Bank</option>
        <option value="Hong Leong Bank">Hong Leong Bank</option>
        <option value="OCBC">OCBC</option>
        <option value="HSBC">HSBC</option>
        <option value="其他">其他</option>
      </select>

      <!-- 银行户口号码 -->
      <input type="text" name="bank_account" placeholder="银行户口号码" required
        pattern="\d{5,20}" title="请输入有效的银行户口号码，仅限数字，长度5-20位" />

      <div class="password-container">
        <input type="password" id="password" name="password" placeholder="密码" required
          pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
          title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
        <img src="images/images/眼睛.png" class="eye-icon" id="toggle-password" alt="显示密码">
      </div>

      <div class="password-container">
        <input type="password" id="confirm_password" name="confirm_password" placeholder="确认密码" required
          pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
          title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
        <img src="images/images/眼睛.png" class="eye-icon" id="toggle-confirm" alt="显示密码">
      </div>

      <button type="submit">发送验证码</button>
    </form>

    <div id="code-container" style="display:none; margin-top: 20px;">
      <input type="text" id="verification_code" placeholder="输入验证码" maxlength="6" pattern="\d{6}" inputmode="numeric" required>
      <button type="button" id="verify-button">验证并注册</button>
    </div>
  </div>
</section>

  <script src="app.js"></script>
  <script>
document.addEventListener("DOMContentLoaded", function () {
  const togglePassword = document.getElementById("toggle-password");
  const password = document.getElementById("password");
  const toggleConfirmPassword = document.getElementById("toggle-confirm");
  const confirmPassword = document.getElementById("confirm_password");
  let visiblePassword = false;
  let visibleConfirmPassword = false;

  togglePassword.addEventListener("click", function () {
    visiblePassword = !visiblePassword;
    password.type = visiblePassword ? "text" : "password";
  });

  toggleConfirmPassword.addEventListener("click", function () {
    visibleConfirmPassword = !visibleConfirmPassword;
    confirmPassword.type = visibleConfirmPassword ? "text" : "password";
  });

  const form = document.getElementById("register-form");
  const codeContainer = document.getElementById("code-container");
  const verifyBtn = document.getElementById("verify-button");
  const codeInput = document.getElementById("verification_code");

  let formData = null;

  // ⚠️ 禁止用户名、邮箱、密码、确认密码输入中文字符
  const emailInput = form.email;
  [emailInput, password, confirmPassword].forEach(input => {
    input.addEventListener("input", function () {
      this.value = this.value.replace(/[\u4e00-\u9fa5]/g, '');
    });
  });

  // ⚠️ 限制验证码只能输入 6 位数字
  codeInput.setAttribute("maxlength", "6");
  codeInput.setAttribute("pattern", "\\d{6}");
  codeInput.setAttribute("title", "请输入 6 位数字验证码");
  codeInput.setAttribute("inputmode", "numeric");
  codeInput.addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, '');
  });

  // ✅ 新增输入限制：
  // 身份证号码只能输入 12 位数字
  const icInput = form.ic_number;
  icInput.setAttribute("maxlength", "12");
  icInput.addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 12);
  });

  // 联系电话只能输入 12 位数字
  const phoneInput = form.phone_number;
  phoneInput.setAttribute("maxlength", "12");
  phoneInput.addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 12);
  });

  // 职位只能输入中英文，不允许数字和特殊符号
  const positionInput = form.position;
  positionInput.addEventListener("input", function () {
    this.value = this.value.replace(/[^a-zA-Z\u4e00-\u9fa5\s]/g, '');
  });

  // 银行户口只能输入最多 20 位数字
  const bankAccountInput = form.bank_account;
  bankAccountInput.setAttribute("maxlength", "20");
  bankAccountInput.addEventListener("input", function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 20);
  });

  // 表单提交：先验证密码一致性再发送验证码
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const password = form.password.value;
    const confirmPassword = form.confirm_password.value;

    if (password !== confirmPassword) {
      alert("两次输入的密码不一致，请检查！");
      return;
    }

    // 收集表单数据（除了验证码）
    formData = {
      name: form.name.value,
      email: form.email.value,
      phone_number: form.phone_number.value,
      ic_number: form.ic_number.value,
      position: form.position.value,
      bank_name: form.bank_name.value,
      bank_account: form.bank_account.value,
      password: password,
      confirm_password: confirmPassword
    };

    fetch("send_verification.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: form.email.value })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("验证码已发送，请查收！");
          codeContainer.style.display = "block";
        } else {
          alert("验证码发送失败：" + data.message);
        }
      })
      .catch(err => {
        console.error("错误:", err);
        alert("发生网络错误！请稍后再试。");
      });
  });

  // 验证验证码
  verifyBtn.addEventListener("click", function () {
    const code = codeInput.value.trim();

    if (!/^\d{6}$/.test(code)) {
      alert("请输入 6 位数字验证码！");
      return;
    }

    fetch("verify_code.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: form.email.value, code: code })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("验证码正确，正在注册...");

          fetch("register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert("注册成功！");
                window.location.href = "login.html";
              } else {
                alert("注册失败：" + data.message);
              }
            })
            .catch(err => {
              console.error("错误:", err);
              alert("注册失败，请稍后重试！");
            });
        } else {
          alert("验证码错误或已过期！");
        }
      })
      .catch(err => {
        console.error("错误:", err);
        alert("发生网络错误，请稍后再试！");
      });
  });
});
</script>

</body>
</html>