<!DOCTYPE html>
<html lang="zh">
<head>
  <link rel="icon" type="image/png" href="images/images/logo.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>注册 - KUNZZ HOLDINGS</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <section class="register-section">
    <div class="register-form">
      <h2>创建新账户</h2>
      <form id="register-form">
        <input type="text" name="username" placeholder="用户名" pattern="[A-Za-z]{2,}" title="用户名只能包含英文字母，且至少两个字符" required />
        <input type="email" name="email" placeholder="请输入您的 Gmail" required pattern="[a-zA-Z0-9._%+-]+@gmail\.com$" title="请输入以 @gmail.com 结尾的邮箱地址" />
        <div class="password-container">
          <input type="password" id="password" name="password" placeholder="密码" required
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
            title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
          <img src="images/images/眼睛.png" class="eye-icon" id="toggle-password" alt="显示密码">
        </div>
        <div class="password-container">
          <input type="password" id="confirm_password" name="confirm_password" placeholder="确认密码" required
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
            title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
          <img src="images/images/眼睛.png" class="eye-icon" id="toggle-confirm" alt="显示密码">
        </div>
        <button type="submit">发送验证码</button>
      </form>

      <div id="code-container" style="display:none; margin-top: 20px;">
        <input type="text" id="verification_code" placeholder="输入验证码" required>
        <button type="button" id="verify-button">验证并注册</button>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const togglePassword = document.getElementById("toggle-password");
      const password = document.getElementById("password");
      const toggleConfirmPassword = document.getElementById("toggle-confirm");
      const confirmPassword = document.getElementById("confirm_password");
      let visiblePassword = false;
      let visibleConfirmPassword = false;

      togglePassword.addEventListener("click", function () {
        visiblePassword = !visiblePassword;
        password.type = visiblePassword ? "text" : "password";
      });

      toggleConfirmPassword.addEventListener("click", function () {
        visibleConfirmPassword = !visibleConfirmPassword;
        confirmPassword.type = visibleConfirmPassword ? "text" : "password";
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("register-form");
      const codeContainer = document.getElementById("code-container");
      const verifyBtn = document.getElementById("verify-button");
      let formData = null;

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const email = form.email.value;
        if (!email.endsWith("@gmail.com")) {
          alert("只能使用 Gmail 注册！");
          return;
        }
        if (confirm("请确认您的注册信息无误，是否继续？")) {
          formData = new FormData(form);
          fetch("send_verification.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: email })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("验证码已发送，请查收！");
              codeContainer.style.display = "block";
            } else {
              alert("验证码发送失败：" + data.message);
            }
          })
          .catch(err => {
            console.error("错误:", err);
            alert("发生网络错误！");
          });
        }
      });

      verifyBtn.addEventListener("click", function () {
        const email = form.email.value;
        const code = document.getElementById("verification_code").value;

        fetch("verify_code.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, code: code })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("验证码正确，正在注册...");
            fetch("register.php", {
              method: "POST",
              body: formData
            })
            .then(() => {
              alert("注册成功！");
              window.location.href = "login.html";
            })
            .catch(() => {
              alert("注册失败，请重试！");
            });
          } else {
            alert("验证码错误或已过期！");
          }
        })
        .catch(err => {
          console.error("错误:", err);
          alert("发生网络错误，请稍后再试！");
        });
      });
    });
  </script>
</body>
</html>