<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>注册会员 - KUNZZ HOLDINGS</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
  <section class="register-section">
    <div class="register-form">
      <h2>注册会员</h2>
      <form id="register-form">
        <input type="text" name="name" placeholder="姓名" required />
        <input type="email" name="email" placeholder="请输入您的 Gmail" required pattern="[a-zA-Z0-9._%+-]+@gmail\.com$" title="请输入以 @gmail.com 结尾的邮箱地址" />
        <input type="tel" name="phone_number" placeholder="联系电话" pattern="^(\+?\d{1,4}[-.\s]?)?(\d{7,15})$" title="请输入有效的电话号码" required />  

        <div class="password-container">
          <input type="password" id="password" name="password" placeholder="密码" required
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
            title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
          <img src="images/images/眼睛.png" id="toggle-password" alt="显示密码" class="eye-icon" style="cursor:pointer;">
        </div>

        <div class="password-container">
          <input type="password" id="confirm_password" name="confirm_password" placeholder="确认密码" required
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])(?!.*[\u4e00-\u9fa5]).{8,}$"
            title="密码至少包含一个大写字母、一个小写字母、一个数字和一个特殊符号，且不少于8个字符，且不能包含中文字符">
          <img src="images/images/眼睛.png" id="toggle-confirm" alt="显示密码" class="eye-icon" style="cursor:pointer;">
        </div>

        <button type="submit">发送验证码</button>
      </form>

      <div id="code-container" style="display:none; margin-top: 20px;">
        <input type="text" id="verification_code" placeholder="输入验证码" maxlength="6" pattern="\d{6}" inputmode="numeric" required>
        <button type="button" id="verify-button">验证并注册</button>
      </div>
    </div>
  </section>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("register-form");
    const codeContainer = document.getElementById("code-container");
    const verifyBtn = document.getElementById("verify-button");
    const codeInput = document.getElementById("verification_code");

    const nameInput = form.querySelector('[name="name"]');
    const emailInput = form.querySelector('[name="email"]');
    const phoneInput = form.querySelector('[name="phone_number"]');
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm_password");

    const togglePassword = document.getElementById("toggle-password");
    const toggleConfirmPassword = document.getElementById("toggle-confirm");

    // 显示/隐藏密码切换
    togglePassword.addEventListener("click", function () {
      const type = passwordInput.type === "password" ? "text" : "password";
      passwordInput.type = type;
    });

    toggleConfirmPassword.addEventListener("click", function () {
      const type = confirmPasswordInput.type === "password" ? "text" : "password";
      confirmPasswordInput.type = type;
    });

    // 禁止中文输入（包含所有汉字）
    function preventChineseInput(el) {
      el.addEventListener("input", function () {
        // 去除所有汉字
        this.value = this.value.replace(/[\p{Script=Han}]/gu, "");
      });
    }

    preventChineseInput(nameInput);
    preventChineseInput(emailInput);
    preventChineseInput(phoneInput);
    preventChineseInput(passwordInput);
    preventChineseInput(confirmPasswordInput);

    // 电话只允许数字，最多12位
    phoneInput.addEventListener("input", function () {
      this.value = this.value.replace(/\D/g, "").slice(0, 12);
    });

    // 验证码输入限制
    codeInput.setAttribute("maxlength", "6");
    codeInput.setAttribute("pattern", "\\d{6}");
    codeInput.setAttribute("title", "请输入 6 位数字验证码");
    codeInput.setAttribute("inputmode", "numeric");
    codeInput.addEventListener("input", function () {
      this.value = this.value.replace(/\D/g, "");
    });

    let formData = null;

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const pwd = passwordInput.value;
      const confirmPwd = confirmPasswordInput.value;

      if (pwd !== confirmPwd) {
        alert("两次输入的密码不一致，请检查！");
        return;
      }

      formData = {
        name: nameInput.value,
        email: emailInput.value,
        phone_number: phoneInput.value,
        password: pwd,
        confirm_password: confirmPwd
      };

      fetch("send_verification.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailInput.value })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("验证码已发送，请查收！");
          codeContainer.style.display = "block";
        } else {
          alert("验证码发送失败：" + data.message);
        }
      })
      .catch(err => {
        console.error("错误:", err);
        alert("发生网络错误！请稍后再试。");
      });
    });

    verifyBtn.addEventListener("click", function () {
      const code = codeInput.value.trim();

      if (!/^\d{6}$/.test(code)) {
        alert("请输入 6 位数字验证码！");
        return;
      }

      fetch("verify_code.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailInput.value, code: code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("验证码正确，正在注册...");

          fetch("register_member.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("注册成功！");
              window.location.href = "login.html";
            } else {
              alert("注册失败：" + data.message);
            }
          })
          .catch(err => {
            console.error("错误:", err);
            alert("注册失败，请稍后重试！");
          });
        } else {
          alert("验证码错误或已过期！");
        }
      })
      .catch(err => {
        console.error("错误:", err);
        alert("发生网络错误，请稍后再试！");
      });
    });
  });
  </script>
</body>
</html>
